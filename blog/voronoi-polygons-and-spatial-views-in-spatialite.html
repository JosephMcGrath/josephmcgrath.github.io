<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="title" content="Voronoi Polygons and Spatial Views in SpatiaLite" />
  <meta name="tags" content="blog, gis, spatialite, sqlite" />
  <meta name="published" content="2018-05-15" />

  <title>Voronoi Polygons and Spatial Views in SpatiaLite</title>
  

  <link rel="stylesheet" type="text/css" href='/code.css'>
  <link rel="stylesheet" type="text/css" href='/main.css'>

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">
</head>

<body>
  <nav class="nav-bar">
    <img src="/nav-bar-icon.png">
    <p>Joe McGrath</p>
    <a href="/index.html">Home</a>
    <a href="/blogs.html">Blogs</a>
  </nav>

  <main>
    

<h1>Voronoi Polygons and Spatial Views in SpatiaLite</h1>

<header>
    <p>
        Published: <i>15/05/2018</i>
    </p>

    
    <p>
        Tags: 
        <a>blog</a>, 
        <a>gis</a>, 
        <a>spatialite</a>, 
        <a>sqlite</a>
    </p>
    
</header>

<hr />

<div class="blog">
    <p>
 <img alt="An example set of voronoi polygons created using the mechanism outlined below." src="/img/voronoi_example.jpg"/>
</p>
<h2>
 SpatiaLite
</h2>
<p>
 <a href="https://www.gaia-gis.it/fossil/libspatialite/index">
  SpatiaLite
 </a>
 is an extension for the widely used SQLite database. Like it's . It's open-source and provides reasonable support for spatial SQL in a portable format. It also has a bit of history with the open-source desktop GIS QGIS and works well with it once you get to grips with how they expect to work together.
</p>
<p>
 Here I'm running through
 <a href="https://github.com/JosephMcGrath/Misc-scripts/blob/master/SQLite/Voronoi_View.sql">
  some code
 </a>
 I wrote a while back in a little more detail.
</p>
<h2>
 Spatial Views
</h2>
<p>
 When I talk about spatial views, I mean a standard SQL view that has an attached geometry (particularly views that generate their own geometry, rather than just passing through a base column). There's nothing special about a spatial view in database terms, it's just a label applied for making the view accessible in a GIS as a typical 'layer'. In this example I'm going through creating a set of Voronoi Polygons for a set of points in SpatiaLite.
</p>
<p>
 It's fairly easy to create a spatial view - but making it usable in QGIS requires it to be registered first. The requirements for this are:
</p>
<ul>
 <li>
  The layer must have an entry in the
  <code>
   views_geometry_columns
  </code>
  table that's part of the SpatiaLite extension. This needs:
  <ul>
   <li>
    The name of the view.
   </li>
   <li>
    The name of the geometry column in that view.
   </li>
   <li>
    The row id for that view.
   </li>
   <li>
    The name of a base table containing a geometry of the same type (ostensibly this is the table that the view is 'based on' - more on this later).
   </li>
   <li>
    The name of the geometry of the same type as the view in the named table.
   </li>
  </ul>
 </li>
 <li>
  The layer to be one QGIS is happy to work with:
  <ul>
   <li>
    Requires a numeric primary key.
   </li>
   <li>
    Must be loaded as a
    <em>
     SpatiaLite
    </em>
    layer rather than a generic vector one (for most things other than just looking at the layer).
   </li>
  </ul>
 </li>
</ul>
<h2>
 Voronoi Polygons in SpatiaLite
</h2>
<p>
 SpatiaLite has
 <a href="http://www.gaia-gis.it/gaia-sins/spatialite-sql-4.2.0.html#p14c">
  a function
 </a>
 that generates voronoi polygons.
 <code>
  VoronojDiagram
 </code>
 is not that convenient for everyday use as it takes a single multi-geometry (probably a multi-point) and outputs a single multi-polygon. In most cases what we want is to push in a table of points and return a table of polygons and it's not too difficult to manually do this.
</p>
<p>
 As an experiment I tried to create a database view that directly converts a table of points into a set of voronoi polygons 'live'. As the points are altered, the polygons change with the output visible in QGIS. The example I've written goes slightly beyond this and allows for multiple sets of points in a table, each with it's own set of voronoi polygons.
</p>
<p>
 The set of operations is going to be:
</p>
<ol>
 <li>
  Merge the inputs into a single multi-geometry for each set.
 </li>
 <li>
  Create the voronoi diagrams.
 </li>
 <li>
  Split up the multi-polygon outputs.
 </li>
 <li>
  Re-attach all the data that was attached to the point.
 </li>
 <li>
  Register the output as a spatial view.
 </li>
</ol>
<p>
 But first, we need some data to work with. I'm just using a set of randomly generated points.
</p>
<h3>
 Generating Example Data
</h3>
<p>
 The table
 <code>
  base_point
 </code>
 is the stand-in for an actual input data.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">base_point</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">pid</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">point_set</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="cm">/*A Voronoi diagram will be created for each unique entry in this column.*/</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">some_data</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="cm">/*Some example data to attach to the outputs.*/</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">the_geom</span><span class="w"> </span><span class="n">POINT</span>
<span class="p">);</span>
</code></pre>
</div>
<p>
 Then registering this base table so it's visible in QGIS (27700 is the reference id for British National Grid). I tend to use the
 <code>
  RecoverGeometryColumn
 </code>
 function to register base geometry columns rather than modifying the
 <code>
  geometry_columns
 </code>
 table as it takes the inputs as text rather than a lookup value for each geometry type. It also lends itself to generating a spatial index at the same time.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="k">SELECT</span>
<span class="w">    </span><span class="n">RecoverGeometryColumn</span><span class="p">(</span><span class="s1">'base_point'</span><span class="p">,</span>
<span class="w">                          </span><span class="s1">'the_geom'</span><span class="p">,</span>
<span class="w">                          </span><span class="mi">27700</span><span class="p">,</span>
<span class="w">                          </span><span class="s1">'POINT'</span><span class="p">,</span>
<span class="w">                          </span><span class="s1">'XY'</span>
<span class="w">                          </span><span class="p">)</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">CreateSpatialIndex</span><span class="p">(</span><span class="s1">'base_point'</span><span class="p">,</span><span class="w"> </span><span class="s1">'the_geom'</span><span class="p">);</span>
</code></pre>
</div>
<p>
 Then generating a set of points to work with. Because of the size of number
 <code>
  RANDOM()
 </code>
 generates, they need to be divided down to values that fit in a reasonable area:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="cm">/*Populate with random points.*/</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">base_point</span>
<span class="w">    </span><span class="p">(</span><span class="n">point_set</span><span class="p">,</span><span class="w"> </span><span class="n">some_data</span><span class="p">,</span><span class="w"> </span><span class="n">the_geom</span><span class="p">)</span>
<span class="k">VALUES</span>
<span class="w">    </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">'Data'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">'in'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">'this'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">'column'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">'will'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">'be'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">'preserved'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">'through'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">'the'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">'Voronoi'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">'creation'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">'process'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">'and'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">'added'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s1">'to'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">'the'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">))</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">'output'</span><span class="p">,</span><span class="w"> </span><span class="n">MakePoint</span><span class="p">(</span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">RANDOM</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="mi">27700</span><span class="p">));</span>
</code></pre>
</div>
<p>
 One additional spanner I'm throwing in the works is the fact that, in normal usage rows will be deleted out of the base points. If this wasn't the case, splitting up the voronoi polygons later would be a bit simpler and process quicker.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">base_point</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</code></pre>
</div>
<h3>
 Merging the Inputs and creating the polygons
</h3>
<p>
 Merging the inputs and generating the raw voronoi polygons is simple enough to do in a single step using
 <code>
  ST_Union
 </code>
 and
 <code>
  GROUP BY
 </code>
 :
</p>
<div class="codehilite">
 <pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">voronoi_raw</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">SELECT</span>
<span class="w">    </span><span class="n">point_set</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">VoronojDiagram</span><span class="p">(</span><span class="n">ST_Union</span><span class="p">(</span><span class="n">the_geom</span><span class="p">),</span><span class="w"> </span><span class="cm">/*Merge the points for each set into a single multipolygon.*/</span>
<span class="w">                   </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="cm">/*We want the polygons, not just the boundaries.*/</span>
<span class="w">                   </span><span class="mi">20</span><span class="w"> </span><span class="cm">/*Return polygons covering an area 20% larger the input.*/</span>
<span class="w">                   </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">the_geom</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">base_point</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="n">point_set</span><span class="p">;</span>
</code></pre>
</div>
<p>
 So now we've got a table with one row for each collection of points. The next step is to split them up.
</p>
<h3>
 Splitting the Polygons
</h3>
<p>
 The theory of this is really simple. Just use
 <code>
  GeometryN
 </code>
 to split the geometries. The problem being that SQLite doesn't natively have any sort of
 <code>
  generate_series
 </code>
 function like PostGIS. The naive approach would be to use the pid column like:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="k">SELECT</span>
<span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">pid</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">point_set</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">GeometryN</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">the_geom</span><span class="p">,</span>
<span class="w">              </span><span class="n">p</span><span class="p">.</span><span class="n">pid</span>
<span class="w">              </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">the_geom</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">base_point</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">p</span>
<span class="w">    </span><span class="k">CROSS</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">voronoi_raw</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">v</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">GeometryN</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">the_geom</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</code></pre>
</div>
<p>
 But this assumes that the pid column will be an unbroken sequence from 1 to the number of rows in the table. That's not an
 <em>
  unreasonable
 </em>
 assumption but the moment the input does into actual use, there's going to be missing or out-of sequence values and there'll be missing geometries. It's also arguably breaks the first normal form by assuming a certain order to the rows.
</p>
<p>
 A more robust approach is to use a subquery to generate a set of values based on the number of parts in each geometry.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">voronoi_split</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">SELECT</span>
<span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">pid</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">point_set</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">GeometryN</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">the_geom</span><span class="p">,</span>
<span class="w">              </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">base_point</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">pid</span><span class="p">)</span>
<span class="w">              </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">the_geom</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">base_point</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">p</span>
<span class="w">    </span><span class="k">CROSS</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">voronoi_raw</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">v</span>
<span class="k">WHERE</span>
<span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">base_point</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">NumGeometries</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">the_geom</span><span class="p">);</span>
</code></pre>
</div>
<p>
 So now we've got a view with one row per polygon, but no data attached.
</p>
<p>
 Another way to work it might be to have a pre-generated table of a numbers, but that requires a certain knowledge about the input data set and I'm trying to make something that's theoretically robust - even if it's a little impractical (and makes some sacrifices on performance).
</p>
<h3>
 Re-joining the Data
</h3>
<p>
 Joining the data from the base point table's very easy. Just a spatial inner join (as the points are guaranteed to be within their own voronoi polygon):
</p>
<div class="codehilite">
 <pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">voronoi_out</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">SELECT</span>
<span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">pid</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">point_set</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">some_data</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">the_geom</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">base_point</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">p</span>
<span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">voronoi_split</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">ST_Within</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">the_geom</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">the_geom</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span>
<span class="w">                                     </span><span class="n">p</span><span class="p">.</span><span class="n">point_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">point_set</span><span class="p">;</span>
</code></pre>
</div>
<p>
 And checking the final view:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">voronoi_out</span><span class="p">;</span>
</code></pre>
</div>
<p>
 Shows we've got all the data through intact. If I was just working in SpatiaLite on it's own this is where the process could stop - but I'm after visualising the results in QGIS.
</p>
<h3>
 Registering the View for use in QGIS
</h3>
<p>
 To register a view, we need a base table with a geometry of the same kind. If we had more tables with polygons we
 <em>
  could
 </em>
 register against that - but it starts to build up unexpected dependencies in the database. I favour a table of dummy geometries:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">dummy_geom</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">pid</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">the_poly</span><span class="w"> </span><span class="n">POLYGON</span>
<span class="p">);</span>

<span class="k">SELECT</span>
<span class="w">    </span><span class="n">RecoverGeometryColumn</span><span class="p">(</span><span class="s1">'dummy_geom'</span><span class="p">,</span>
<span class="w">                          </span><span class="s1">'the_poly'</span><span class="p">,</span>
<span class="w">                          </span><span class="mi">27700</span><span class="p">,</span>
<span class="w">                          </span><span class="s1">'POLYGON'</span><span class="p">,</span>
<span class="w">                          </span><span class="s1">'XY'</span>
<span class="w">                          </span><span class="p">);</span>
</code></pre>
</div>
<p>
 Especially combined with the option to hide the registered table by altering the
 <code>
  geometry_columns_auth
 </code>
 table:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="k">UPDATE</span><span class="w"> </span><span class="n">geometry_columns_auth</span>
<span class="k">SET</span><span class="w"> </span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">f_table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'dummy_geom'</span><span class="p">;</span>
</code></pre>
</div>
<p>
 And then it's just a simple
 <code>
  INSERT
 </code>
 to register the view:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">views_geometry_columns</span>
<span class="w">    </span><span class="p">(</span><span class="n">view_name</span><span class="p">,</span><span class="w"> </span><span class="n">view_geometry</span><span class="p">,</span><span class="w"> </span><span class="n">view_rowid</span><span class="p">,</span><span class="w"> </span><span class="n">f_table_name</span><span class="p">,</span><span class="w"> </span><span class="n">f_geometry_column</span><span class="p">,</span><span class="w"> </span><span class="n">read_only</span><span class="p">)</span>
<span class="k">VALUES</span>
<span class="w">    </span><span class="p">(</span><span class="s1">'voronoi_out'</span><span class="p">,</span><span class="w"> </span><span class="s1">'the_geom'</span><span class="p">,</span><span class="w"> </span><span class="s1">'pid'</span><span class="p">,</span><span class="w"> </span><span class="s1">'dummy_geom'</span><span class="p">,</span><span class="w"> </span><span class="s1">'the_poly'</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</code></pre>
</div>
<p>
 Which makes it available for viewing in QGIS.
</p>
<p>
 <img alt="The QGIS 3 menu for loading the voronoi polygons." src="/img/voronoi_load.jpg"/>
</p>

</div>

  </main>
</body>

</html>